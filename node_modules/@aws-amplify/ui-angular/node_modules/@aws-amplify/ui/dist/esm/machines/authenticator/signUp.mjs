import{__awaiter as e,__generator as t}from"tslib";import{Auth as n}from"aws-amplify";import{createMachine as r,sendUpdate as i,assign as s}from"xstate";import{runValidators as a}from"../../validators/index.mjs";import{clearError as o,clearFormValues as d,clearTouched as c,clearValidationError as l,handleInput as u,handleSubmit as m,handleBlur as p,parsePhoneNumber as g,setCredentials as f,setFieldErrors as h,setRemoteError as v,setCodeDeliveryDetails as U,setUser as S}from"./actions.mjs";import"lodash/isEqual.js";import"lodash/isEmpty.js";import"lodash/debounce.js";import"lodash/isNil.js";import"lodash/includes.js";import E from"lodash/get.js";import b from"lodash/pickBy.js";import"lodash/has.js";import"lodash/kebabCase.js";import"lodash/merge.js";function y(y){var C=y.services;return r({id:"signUpActor",initial:"init",predictableActionArguments:!0,states:{init:{always:[{target:"confirmSignUp",cond:"shouldInitConfirmSignUp"},{target:"signUp"}]},signUp:{type:"parallel",exit:["clearError","clearFormValues","clearTouched"],states:{validation:{initial:"pending",states:{pending:{invoke:{src:"validateSignUp",onDone:{target:"valid",actions:"clearValidationError"},onError:{target:"invalid",actions:"setFieldErrors"}}},valid:{entry:"sendUpdate"},invalid:{entry:"sendUpdate"}},on:{CHANGE:{actions:"handleInput",target:".pending"},BLUR:{actions:"handleBlur",target:".pending"}}},submission:{initial:"idle",states:{idle:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"validate"},FEDERATED_SIGN_IN:"federatedSignIn"}},federatedSignIn:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"federatedSignIn",onDone:"#signUpActor.resolved",onError:{actions:"setRemoteError"}}},validate:{entry:"sendUpdate",invoke:{src:"validateSignUp",onDone:{target:"pending",actions:"clearValidationError"},onError:{target:"idle",actions:"setFieldErrors"}}},pending:{tags:["pending"],entry:["parsePhoneNumber","sendUpdate","clearError"],invoke:{src:"signUp",onDone:[{cond:"shouldSkipConfirm",target:"skipConfirm",actions:["setUser","setCredentials"]},{target:"resolved",actions:["setUser","setCredentials","setCodeDeliveryDetails"]}],onError:{target:"idle",actions:"setRemoteError"}}},skipConfirm:{always:{target:"#signUpActor.resolved",actions:"setAutoSignInIntent"}},resolved:{type:"final",always:"#signUpActor.confirmSignUp"}}}}},confirmSignUp:{initial:"edit",states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},CHANGE:{actions:"handleInput"},BLUR:{actions:"handleBlur"},RESEND:"resend"}},resend:{tags:["pending"],entry:"sendUpdate",invoke:{src:"resendConfirmationCode",onDone:{target:"edit"},onError:[{target:"#signUpActor.resolved",actions:"setAutoSignInIntent",cond:"isUserAlreadyConfirmed"},{target:"edit",actions:"setRemoteError"}]}},submit:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"confirmSignUp",onDone:{target:"#signUpActor.resolved",actions:"setAutoSignInIntent"},onError:{target:"edit",actions:"setRemoteError"}}}}},resolved:{type:"final",data:function(e,t){var n=e.authAttributes,r=n.username,i=n.password;return{user:E(t,"data.user")||e.user,authAttributes:{username:r,password:i},intent:e.intent}}}}},{guards:{isUserAlreadyConfirmed:function(e,t){return"User is already confirmed."===t.data.message},shouldInitConfirmSignUp:function(e){return e.intent&&"confirmSignUp"===e.intent},shouldSkipConfirm:function(e,t){return t.data.userConfirmed}},actions:{clearError:o,clearFormValues:d,clearTouched:c,clearValidationError:l,handleInput:u,handleSubmit:m,handleBlur:p,parsePhoneNumber:g,setCredentials:f,setFieldErrors:h,setRemoteError:v,setCodeDeliveryDetails:U,setUser:S,sendUpdate:i(),setAutoSignInIntent:s({intent:function(e){return"confirmSignUp"===(null==e?void 0:e.intent)?"autoSignInSubmit":"autoSignIn"}})},services:{confirmSignUp:function(n,r){return e(this,void 0,void 0,(function(){var e,r,i,s,a;return t(this,(function(t){switch(t.label){case 0:return e=n.user,r=n.authAttributes,i=n.formValues,s=i.confirmation_code,a=E(e,"username")||E(r,"username"),[4,C.handleConfirmSignUp({username:a,code:s})];case 1:return[2,t.sent()]}}))}))},resendConfirmationCode:function(r,i){return e(this,void 0,void 0,(function(){var e,i,s;return t(this,(function(t){return e=r.user,i=r.authAttributes,s=E(e,"username")||E(i,"username"),[2,n.resendSignUp(s)]}))}))},federatedSignIn:function(r,i){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return e=i.data.provider,[4,n.federatedSignIn({provider:e})];case 1:return[2,t.sent()]}}))}))},signUp:function(n,r){return e(this,void 0,void 0,(function(){var e,r,i,s,a,o,d;return t(this,(function(t){switch(t.label){case 0:return e=n.formValues,r=n.loginMechanisms,i=r[0],a=(s=e)[void 0===i?"username":i],o=s.password,d=b(e,(function(e,t){switch(t){case"address":case"birthdate":case"email":case"family_name":case"gender":case"given_name":case"locale":case"middle_name":case"name":case"nickname":case"phone_number":case"picture":case"preferred_username":case"profile":case"updated_at":case"website":case"zoneinfo":return!0;default:return t.startsWith("custom:")}})),[4,C.handleSignUp({username:a,password:o,attributes:d})];case 1:return[2,t.sent()]}}))}))},validateSignUp:function(n,r){return e(this,void 0,void 0,(function(){return t(this,(function(e){return[2,a(n.formValues,n.touched,n.passwordSettings,[C.validateFormPassword,C.validateConfirmPassword,C.validatePreferredUsername,C.validateCustomSignUp])]}))}))}}})}export{y as createSignUpMachine};
