import{__assign as t,__spreadArray as o,__rest as n}from"tslib";import{actions as i,createMachine as r,forwardTo as e,assign as a,spawn as s}from"xstate";import{stopActor as c}from"./actions.mjs";import{signInActor as u}from"./actors/signIn.mjs";import{signOutActor as d}from"./actors/signOut.mjs";import{resetPasswordActor as l}from"./actors/resetPassword.mjs";import{defaultServices as g}from"./defaultServices.mjs";import{createSignUpMachine as v}from"./signUp.mjs";var f=i.choose;function p(){return r({id:"authenticator",initial:"idle",context:{user:void 0,config:{},services:g,actorRef:void 0,hasSetup:!1},predictableActionArguments:!0,states:{idle:{invoke:{src:"getCurrentUser",onDone:{actions:"setUser",target:"authenticated"},onError:{target:"setup"}}},setup:{initial:"waitConfig",states:{waitConfig:{on:{INIT:{actions:["configure","setHasSetup"],target:"applyConfig"}}},applyConfig:{invoke:{src:"getAmplifyConfig",onDone:{actions:"applyAmplifyConfig",target:"goToInitialState"}}},goToInitialState:{always:[{target:"#authenticator.signUp",cond:"isInitialStateSignUp"},{target:"#authenticator.resetPassword",cond:"isInitialStateResetPassword"},{target:"#authenticator.signIn"}]}}},signIn:{initial:"spawnActor",states:{spawnActor:{always:{actions:"spawnSignInActor",target:"runActor"}},runActor:{entry:"clearActorDoneData",exit:"stopSignInActor"}},on:{SIGN_UP:"signUp",RESET_PASSWORD:"resetPassword","done.invoke.signInActor":[{target:"signUp",actions:"setActorDoneData",cond:"shouldRedirectToSignUp"},{target:"resetPassword",actions:"setActorDoneData",cond:"shouldRedirectToResetPassword"},{target:"authenticated",actions:"setActorDoneData"}]}},signUp:{initial:"spawnActor",states:{spawnActor:{always:{actions:"spawnSignUpActor",target:"runActor"}},runActor:{entry:"clearActorDoneData",exit:"stopSignUpActor"},autoSignIn:{invoke:{src:"getCurrentUser",onDone:"#authenticator.authenticated",onError:"#authenticator.setup.goToInitialState"}}},on:{SIGN_IN:"signIn","done.invoke.signUpActor":{target:"#authenticator.signIn",actions:"setActorDoneData",cond:"shouldAutoSignIn"}}},resetPassword:{initial:"spawnActor",states:{spawnActor:{always:{actions:"spawnResetPasswordActor",target:"runActor"}},runActor:{entry:"clearActorDoneData",exit:"stopResetPasswordActor"}},on:{SIGN_IN:"signIn","done.invoke.resetPasswordActor":{target:"signIn",actions:"setActorDoneData"}}},signOut:{initial:"spawnActor",states:{spawnActor:{always:{actions:"spawnSignOutActor",target:"runActor"}},runActor:{entry:"clearActorDoneData",exit:["stopSignOutActor","clearUser"]}},on:{"done.invoke.signOutActor":[{target:"setup",cond:"shouldSetup"},{target:"setup.goToInitialState"}]}},authenticated:{initial:"idle",states:{idle:{on:{TOKEN_REFRESH:"refreshUser"}},refreshUser:{invoke:{src:"getCurrentUser",onDone:{actions:"setUser",target:"idle"},onError:{target:"#authenticator.signOut"}}}},on:{SIGN_OUT:"signOut"}}},on:{CHANGE:{actions:"forwardToActor"},BLUR:{actions:"forwardToActor"},SUBMIT:{actions:"forwardToActor"},FEDERATED_SIGN_IN:{actions:"forwardToActor"},AUTO_SIGN_IN:{actions:"forwardToActor"},RESEND:{actions:"forwardToActor"},SIGN_IN:{actions:"forwardToActor"},SKIP:{actions:"forwardToActor"}}},{actions:{forwardToActor:f([{cond:"hasActor",actions:e((function(t){return t.actorRef}))}]),setUser:a({user:function(t,o){return o.data}}),setActorDoneData:a({actorDoneData:function(o,n){var i,r;return{authAttributes:t({},null===(i=n.data)||void 0===i?void 0:i.authAttributes),intent:null===(r=n.data)||void 0===r?void 0:r.intent}},user:function(t,o){var n;return null===(n=o.data)||void 0===n?void 0:n.user}}),clearUser:a({user:void 0}),clearActorDoneData:a({actorDoneData:void 0}),applyAmplifyConfig:a({config:function(t,n){var i,r,e,a,s,c,u,d,l,g=null!==(r=null===(i=n.data.aws_cognito_username_attributes)||void 0===i?void 0:i.map((function(t){return t.toLowerCase()})))&&void 0!==r?r:[],v=null!==(a=null===(e=n.data.aws_cognito_verification_mechanisms)||void 0===e?void 0:e.map((function(t){return t.toLowerCase()})))&&void 0!==a?a:[],f=null!==(c=null===(s=n.data.aws_cognito_signup_attributes)||void 0===s?void 0:s.map((function(t){return t.toLowerCase()})))&&void 0!==c?c:[],p=null!==(d=null===(u=n.data.aws_cognito_social_providers)||void 0===u?void 0:u.map((function(t){return t.toLowerCase()})))&&void 0!==d?d:[],w=n.data.aws_cognito_password_protection_settings||{};0===g.length&&g.push("username");var S=t.config,m=S.loginMechanisms,h=S.signUpAttributes,D=S.socialProviders,I=S.initialState;return{loginMechanisms:null!=m?m:g,formFields:null!==(l=A(S.formFields))&&void 0!==l?l:{},passwordSettings:w,signUpAttributes:null!=h?h:Array.from(new Set(o(o([],v,!0),f,!0))),socialProviders:null!=D?D:p.sort(),initialState:I}}}),spawnSignInActor:a({actorRef:function(t,o){var n,i,r,e,a,c,d,l=t.services,g=u({services:l}).withContext({authAttributes:null!==(i=null===(n=t.actorDoneData)||void 0===n?void 0:n.authAttributes)&&void 0!==i?i:{},user:t.user,intent:null===(r=t.actorDoneData)||void 0===r?void 0:r.intent,country_code:"+1",formValues:{},touched:{},validationError:{},passwordSettings:null===(e=t.config)||void 0===e?void 0:e.passwordSettings,loginMechanisms:null===(a=t.config)||void 0===a?void 0:a.loginMechanisms,socialProviders:null===(c=t.config)||void 0===c?void 0:c.socialProviders,formFields:null===(d=t.config)||void 0===d?void 0:d.formFields});return s(g,{name:"signInActor"})}}),spawnSignUpActor:a({actorRef:function(t,o){var n,i,r,e,a,c,u,d=t.services,l=v({services:d}).withContext({authAttributes:null!==(i=null===(n=t.actorDoneData)||void 0===n?void 0:n.authAttributes)&&void 0!==i?i:{},country_code:"+1",intent:null===(r=t.actorDoneData)||void 0===r?void 0:r.intent,formValues:{},touched:{},validationError:{},loginMechanisms:null===(e=t.config)||void 0===e?void 0:e.loginMechanisms,socialProviders:null===(a=t.config)||void 0===a?void 0:a.socialProviders,formFields:null===(c=t.config)||void 0===c?void 0:c.formFields,passwordSettings:null===(u=t.config)||void 0===u?void 0:u.passwordSettings});return s(l,{name:"signUpActor"})}}),spawnResetPasswordActor:a({actorRef:function(t,o){var n,i,r,e,a,c=t.services,u=l({services:c}).withContext({formValues:{},touched:{},intent:null===(n=t.actorDoneData)||void 0===n?void 0:n.intent,username:null===(r=null===(i=t.actorDoneData)||void 0===i?void 0:i.authAttributes)||void 0===r?void 0:r.username,formFields:null===(e=t.config)||void 0===e?void 0:e.formFields,validationError:{},passwordSettings:null===(a=t.config)||void 0===a?void 0:a.passwordSettings});return s(u,{name:"resetPasswordActor"})}}),spawnSignOutActor:a({actorRef:function(t){var o=d.withContext({user:t.user});return s(o,{name:"signOutActor"})}}),stopSignInActor:c("signInActor"),stopSignUpActor:c("signUpActor"),stopResetPasswordActor:c("resetPasswordActor"),stopSignOutActor:c("signOutActor"),configure:a((function(o,i){var r=i.data,e=r.services,a=n(r,["services"]);return{services:t(t({},g),e),config:a}})),setHasSetup:a({hasSetup:!0})},guards:{isInitialStateSignUp:function(t){return"signUp"===t.config.initialState},isInitialStateResetPassword:function(t){return"resetPassword"===t.config.initialState},shouldRedirectToSignUp:function(t,o){var n;return"confirmSignUp"===(null===(n=o.data)||void 0===n?void 0:n.intent)},shouldRedirectToResetPassword:function(t,o){var n;return"confirmPasswordReset"===(null===(n=o.data)||void 0===n?void 0:n.intent)},shouldAutoSignIn:function(t,o){var n,i;return"autoSignIn"===(null===(n=o.data)||void 0===n?void 0:n.intent)||"autoSignInSubmit"===(null===(i=o.data)||void 0===i?void 0:i.intent)},shouldSetup:function(t){return!1===t.hasSetup},hasActor:function(t){return!!t.actorRef}},services:{getCurrentUser:function(t,o){return t.services.getCurrentUser()},getAmplifyConfig:function(t,o){return t.services.getAmplifyConfig()}}})}function A(t){return t&&Object.keys(t).forEach((function(o){Object.keys(t[o]).forEach((function(n){var i=t[o][n];i.required=i.isRequired}))})),t}export{p as createAuthenticatorMachine};
