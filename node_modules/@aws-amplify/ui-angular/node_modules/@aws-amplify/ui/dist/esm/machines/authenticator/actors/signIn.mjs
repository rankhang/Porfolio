import{__awaiter as e,__generator as t,__assign as r,__rest as n}from"tslib";import{Auth as o}from"aws-amplify";import{createMachine as i,sendUpdate as s}from"xstate";import{runValidators as a}from"../../../validators/index.mjs";import{clearAttributeToVerify as c,clearChallengeName as d,clearRequiredAttributes as u,clearError as l,clearFormValues as g,clearTouched as m,clearUnverifiedContactMethods as f,clearValidationError as h,handleInput as p,handleSubmit as v,handleBlur as I,parsePhoneNumber as S,setChallengeName as A,setConfirmResetPasswordIntent as U,setConfirmSignUpIntent as E,setRequiredAttributes as T,setCredentials as b,setFieldErrors as C,setRemoteError as y,setTotpSecretCode as N,setUnverifiedContactMethods as w,setUser as R,setUsernameAuthAttributes as P}from"../actions.mjs";import{defaultServices as V}from"../defaultServices.mjs";import"lodash/isEqual.js";import _ from"lodash/isEmpty.js";import"lodash/debounce.js";import"lodash/isNil.js";import"lodash/includes.js";import F from"lodash/get.js";import"lodash/pickBy.js";import"lodash/has.js";import"lodash/kebabCase.js";import"lodash/merge.js";var j=["SMS_MFA","SOFTWARE_TOKEN_MFA"],k=function(e){return F(e,"data.challengeName")},O=function(e,t){return e===t},D=function(e){return j.includes(e)};function M(F){var j=F.services;return i({initial:"init",id:"signInActor",predictableActionArguments:!0,states:{init:{always:[{target:"autoSignIn.submit",cond:"shouldAutoSubmit"},{target:"autoSignIn",cond:"shouldAutoSignIn"},{target:"signIn"}]},signIn:{initial:"edit",exit:["clearFormValues","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},CHANGE:{actions:"handleInput"},FEDERATED_SIGN_IN:"federatedSignIn"}},federatedSignIn:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"federatedSignIn",onError:{actions:"setRemoteError"}}},submit:{tags:["pending"],entry:["parsePhoneNumber","clearError","sendUpdate"],invoke:{src:"signIn",onDone:[{cond:"shouldSetupTOTP",actions:["setUser","setChallengeName"],target:"#signInActor.setupTOTP"},{cond:"shouldConfirmSignIn",actions:["setUser","setChallengeName"],target:"#signInActor.confirmSignIn"},{cond:"shouldForceChangePassword",actions:["setUser","setChallengeName","setRequiredAttributes"],target:"#signInActor.forceNewPassword"},{actions:"setUser",target:"verifying"}],onError:[{cond:"shouldRedirectToConfirmSignUp",actions:["setCredentials","setConfirmSignUpIntent"],target:"rejected"},{cond:"shouldRedirectToConfirmResetPassword",actions:["setUsernameAuthAttributes","setConfirmResetPasswordIntent"],target:"rejected"},{actions:"setRemoteError",target:"edit"}]}},verifying:{tags:["pending"],entry:["clearError","sendUpdate"],invoke:{src:"checkVerifiedContact",onDone:[{cond:"shouldRequestVerification",target:"#signInActor.verifyUser",actions:"setUnverifiedContactMethods"},{target:"resolved"}],onError:{actions:"setRemoteError",target:"edit"}}},resolved:{always:"#signInActor.resolved"},rejected:{always:"#signInActor.rejected"}}},autoSignIn:{initial:"pending",states:{pending:{tags:["pending"],entry:["clearError","sendUpdate"],on:{AUTO_SIGN_IN:[{cond:"shouldSetupTOTP",actions:["setUser","setChallengeName"],target:"#signInActor.setupTOTP"},{cond:"shouldConfirmSignIn",actions:["setUser","setChallengeName"],target:"#signInActor.confirmSignIn"},{cond:"shouldForceChangePassword",actions:["setUser","setChallengeName","setRequiredAttributes"],target:"#signInActor.forceNewPassword"},{actions:"setUser",target:"#signInActor.resolved"}],AUTO_SIGN_IN_FAILURE:{actions:"setRemoteError",target:"pending"}}},submit:{tags:["pending"],entry:["clearError","sendUpdate"],invoke:{src:"signIn",onDone:[{cond:"shouldSetupTOTP",actions:["setUser","setChallengeName"],target:"#signInActor.setupTOTP"},{cond:"shouldConfirmSignIn",actions:["setUser","setChallengeName"],target:"#signInActor.confirmSignIn"},{cond:"shouldForceChangePassword",actions:["setUser","setChallengeName","setRequiredAttributes"],target:"#signInActor.forceNewPassword"},{actions:"setUser",target:"#signInActor.resolved"}],onError:{actions:"setRemoteError",target:"#signInActor.signIn"}}},resolved:{always:"#signInActor.resolved"},rejected:{always:"#signInActor.rejected"}}},confirmSignIn:{initial:"edit",exit:["clearFormValues","clearError","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},SIGN_IN:"#signInActor.signIn",CHANGE:{actions:"handleInput"}}},submit:{tags:["pending"],entry:["clearError","sendUpdate"],invoke:{src:"confirmSignIn",onDone:{target:"#signInActor.resolved",actions:["setUser","clearChallengeName","clearRequiredAttributes"]},onError:{target:"edit",actions:"setRemoteError"}}}}},forceNewPassword:{type:"parallel",exit:["clearFormValues","clearError","clearTouched"],states:{validation:{initial:"pending",states:{pending:{invoke:{src:"validateFields",onDone:{target:"valid",actions:"clearValidationError"},onError:{target:"invalid",actions:"setFieldErrors"}}},valid:{entry:"sendUpdate"},invalid:{entry:"sendUpdate"}},on:{SIGN_IN:"#signInActor.signIn",CHANGE:{actions:"handleInput",target:".pending"},BLUR:{actions:"handleBlur",target:".pending"}}},submit:{initial:"idle",entry:"clearError",states:{idle:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"validate"}}},validate:{entry:"sendUpdate",invoke:{src:"validateFields",onDone:{target:"pending",actions:"clearValidationError"},onError:{target:"idle",actions:"setFieldErrors"}}},pending:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"forceNewPassword",onDone:[{cond:"shouldConfirmSignIn",actions:["setUser","setChallengeName"],target:"#signInActor.confirmSignIn"},{cond:"shouldSetupTOTP",actions:["setUser","setChallengeName"],target:"#signInActor.setupTOTP"},{target:"resolved",actions:["setUser","setCredentials"]}],onError:{target:"idle",actions:"setRemoteError"}}},resolved:{type:"final",always:"#signInActor.resolved"}}}}},setupTOTP:{initial:"getTotpSecretCode",exit:["clearFormValues","clearError","clearTouched"],states:{getTotpSecretCode:{invoke:{src:"getTotpSecretCode",onDone:{target:"edit",actions:"setTotpSecretCode"},onError:{target:"edit",actions:"setRemoteError"}}},edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},SIGN_IN:"#signInActor.signIn",CHANGE:{actions:"handleInput"}}},submit:{tags:["pending"],entry:["sendUpdate","clearError"],invoke:{src:"verifyTotpToken",onDone:{actions:["clearChallengeName","clearRequiredAttributes"],target:"#signInActor.resolved"},onError:{actions:"setRemoteError",target:"edit"}}}}},verifyUser:{initial:"edit",exit:["clearFormValues","clearError","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},SKIP:"#signInActor.resolved",CHANGE:{actions:"handleInput"}}},submit:{tags:["pending"],entry:"clearError",invoke:{src:"verifyUser",onDone:{target:"#signInActor.confirmVerifyUser"},onError:{actions:"setRemoteError",target:"edit"}}}}},confirmVerifyUser:{initial:"edit",exit:["clearFormValues","clearError","clearUnverifiedContactMethods","clearAttributeToVerify","clearTouched"],states:{edit:{entry:"sendUpdate",on:{SUBMIT:{actions:"handleSubmit",target:"submit"},SKIP:"#signInActor.resolved",CHANGE:{actions:"handleInput"}}},submit:{tags:["pending"],entry:"clearError",invoke:{src:"confirmVerifyUser",onDone:{target:"#signInActor.resolved"},onError:{actions:"setRemoteError",target:"edit"}}}}},resolved:{type:"final",data:function(e){return{user:e.user}}},rejected:{type:"final",data:function(e,t){return{intent:e.redirectIntent,authAttributes:e.authAttributes}}}}},{actions:{clearAttributeToVerify:c,clearChallengeName:d,clearRequiredAttributes:u,clearError:l,clearFormValues:g,clearTouched:m,clearUnverifiedContactMethods:f,clearValidationError:h,handleInput:p,handleSubmit:v,handleBlur:I,parsePhoneNumber:S,setChallengeName:A,setConfirmResetPasswordIntent:U,setConfirmSignUpIntent:E,setRequiredAttributes:T,setCredentials:b,setFieldErrors:C,setRemoteError:y,setTotpSecretCode:N,setUnverifiedContactMethods:w,setUser:R,setUsernameAuthAttributes:P,sendUpdate:s()},guards:{shouldAutoSignIn:function(e){return"autoSignIn"===(null==e?void 0:e.intent)},shouldAutoSubmit:function(e){return"autoSignInSubmit"===(null==e?void 0:e.intent)},shouldConfirmSignIn:function(e,t){return D(k(t))},shouldForceChangePassword:function(e,t){return O(k(t),"NEW_PASSWORD_REQUIRED")},shouldRedirectToConfirmResetPassword:function(e,t){return"PasswordResetRequiredException"===t.data.code},shouldRedirectToConfirmSignUp:function(e,t){return"UserNotConfirmedException"===t.data.code},shouldRequestVerification:function(e,t){var r=t.data,n=r.unverified,o=r.verified;return _(o)&&!_(n)},shouldSetupTOTP:function(e,t){return O(k(t),"MFA_SETUP")}},services:{signIn:function(n){return e(this,void 0,void 0,(function(){var e,o,i,s,a,c,d;return t(this,(function(t){switch(t.label){case 0:return e=n.authAttributes,o=void 0===e?{}:e,i=n.formValues,s=void 0===i?{}:i,a=r(r({},o),s),c=a.username,d=a.password,[4,j.handleSignIn({username:c,password:d})];case 1:return[2,t.sent()]}}))}))},confirmSignIn:function(r){return e(this,void 0,void 0,(function(){var e,n,i,s;return t(this,(function(t){switch(t.label){case 0:return e=r.challengeName,n=r.user,i=r.formValues.confirmation_code,s=D(e)?e:void 0,[4,j.handleConfirmSignIn({user:n,code:i,mfaType:s})];case 1:return t.sent(),[4,o.currentAuthenticatedUser()];case 2:return[2,t.sent()]}}))}))},forceNewPassword:function(i){return e(this,void 0,void 0,(function(){var e,s,a,c,d,u,l,g,m;return t(this,(function(t){switch(t.label){case 0:e=i.user,s=i.formValues,a=s.password,s.confirm_password,c=s.phone_number,d=s.country_code,u=n(s,["password","confirm_password","phone_number","country_code"]),c&&(l="".concat(d).concat(c).replace(/[^A-Z0-9+]/gi,""),u=r(r({},u),{phone_number:l})),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,o.completeNewPassword(e,a,u)];case 2:return(g=t.sent()).challengeName?[2,g]:[2,o.currentAuthenticatedUser()];case 3:return m=t.sent(),[2,Promise.reject(m)];case 4:return[2]}}))}))},getTotpSecretCode:function(r){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){return e=r.user,[2,o.setupTOTP(e)]}))}))},verifyTotpToken:function(r){return e(this,void 0,void 0,(function(){var e,n,i;return t(this,(function(t){return e=r.formValues,n=r.user,i=e.confirmation_code,[2,o.verifyTotpToken(n,i)]}))}))},federatedSignIn:function(r,n){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return e=n.data.provider,[4,o.federatedSignIn({provider:e})];case 1:return[2,t.sent()]}}))}))},checkVerifiedContact:function(r){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return e=r.user,[4,o.verifiedContact(e)];case 1:return[2,t.sent()]}}))}))},verifyUser:function(r){return e(this,void 0,void 0,(function(){var e,n;return t(this,(function(t){switch(t.label){case 0:return e=r.formValues.unverifiedAttr,[4,o.verifyCurrentUserAttribute(e)];case 1:return n=t.sent(),r.attributeToVerify=e,[2,n]}}))}))},confirmVerifyUser:function(r){return e(this,void 0,void 0,(function(){var e,n;return t(this,(function(t){switch(t.label){case 0:return e=r.attributeToVerify,n=r.formValues.confirmation_code,[4,o.verifyCurrentUserAttributeSubmit(e,n)];case 1:return[2,t.sent()]}}))}))},validateFields:function(r){return e(this,void 0,void 0,(function(){return t(this,(function(e){return[2,a(r.formValues,r.touched,r.passwordSettings,[V.validateFormPassword,V.validateConfirmPassword])]}))}))}}})}export{M as signInActor};
